# =============================================================================
# Docker Compose for Local Development
# =============================================================================
# Provides separate services for API and Frontend with proper networking
# =============================================================================

version: '3.8'

services:
  # ---------------------------------------------------------------------------
  # FastAPI Backend Service
  # ---------------------------------------------------------------------------
  api:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: research-assistant-api
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload
    ports:
      - "8000:8000"
    environment:
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - MODEL_PROVIDER=${MODEL_PROVIDER:-groq}
      - GROQ_API_KEY=${GROQ_API_KEY}
      - TAVILY_API_KEY=${TAVILY_API_KEY:-}
      - LANGSMITH_API_KEY=${LANGSMITH_API_KEY:-}
      - LANGSMITH_TRACING=${LANGSMITH_TRACING:-false}
      - PYTHONUNBUFFERED=1
    volumes:
      # Mount source code for hot reload during development
      - ./agent:/app/agent
      - ./tools:/app/tools
      - ./utils:/app/utils
      - ./models:/app/models
      - ./prompt_library:/app/prompt_library
      - ./config:/app/config
      - ./logger:/app/logger
      - ./main.py:/app/main.py
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - research-network
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Streamlit Frontend Service
  # ---------------------------------------------------------------------------
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: research-assistant-frontend
    command: streamlit run app.py --server.port=7860 --server.address=0.0.0.0 --server.headless=true
    ports:
      - "7860:7860"
    environment:
      - RESEARCH_ENDPOINT=http://api:8000/research
    volumes:
      - ./app.py:/app/app.py
    depends_on:
      api:
        condition: service_healthy
    networks:
      - research-network
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Test Runner Service (for CI/CD)
  # ---------------------------------------------------------------------------
  tests:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: research-assistant-tests
    command: python tests/test_langsmith_evaluation.py
    environment:
      - MODEL_PROVIDER=${MODEL_PROVIDER:-groq}
      - GROQ_API_KEY=${GROQ_API_KEY}
      - TAVILY_API_KEY=${TAVILY_API_KEY:-}
      - LANGSMITH_API_KEY=${LANGSMITH_API_KEY:-}
      - LANGSMITH_TRACING=${LANGSMITH_TRACING:-true}
    profiles:
      - test
    networks:
      - research-network

networks:
  research-network:
    driver: bridge
    name: research-assistant-network

# =============================================================================
# Usage:
# =============================================================================
# Development:
#   docker-compose up --build
#
# Run tests:
#   docker-compose --profile test run tests
#
# Production (single container):
#   docker build -t research-assistant .
#   docker run -p 7860:7860 -p 8000:8000 research-assistant
# =============================================================================
